(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const s of document.querySelectorAll('link[rel="modulepreload"]'))a(s);new MutationObserver(s=>{for(const o of s)if(o.type==="childList")for(const i of o.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&a(i)}).observe(document,{childList:!0,subtree:!0});function n(s){const o={};return s.integrity&&(o.integrity=s.integrity),s.referrerPolicy&&(o.referrerPolicy=s.referrerPolicy),s.crossOrigin==="use-credentials"?o.credentials="include":s.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function a(s){if(s.ep)return;s.ep=!0;const o=n(s);fetch(s.href,o)}})();const Pt=9,bt=["berry","candy","citrus","gem","star","heart"],Ge=60,Qn=1.5,En=100;let ea=1;const Tn=()=>Math.random();function tt(e,t){return{id:ea++,kind:e,special:t}}function kt(){const e=Math.floor(Tn()*bt.length);return bt[e]}function K(e){return e.map(t=>t.map(n=>n?{...n}:null))}function St(e=Pt){let t=0;for(;t<En;){const n=Array.from({length:e},()=>Array.from({length:e},()=>null));for(let a=0;a<e;a++)for(let s=0;s<e;s++){let o=kt(),i=0;for(;na(n,a,s,o)&&i<10;)o=kt(),i++;n[a][s]=tt(o)}if(Lt(n))return n;t++}throw new Error("Unable to generate a valid starting board")}function ta(e){var a;const t=e.length,n=((a=e[0])==null?void 0:a.length)??0;if(t===0||n===0)throw new Error("Layout must have at least one row and one column");return e.map(s=>{if(s.length!==n)throw new Error("All rows in the layout must have the same length");return s.map(o=>tt(o))})}function na(e,t,n,a){const s=n>0?e[t][n-1]:null,o=n>1?e[t][n-2]:null;if(s&&o&&s.kind===a&&o.kind===a)return!0;const i=t>0?e[t-1][n]:null,r=t>1?e[t-2][n]:null;return!!(i&&r&&i.kind===a&&r.kind===a)}function ee(e,t){return t.row>=0&&t.row<e.length&&t.col>=0&&t.col<e[0].length}function aa(e,t){const n=Math.abs(e.row-t.row),a=Math.abs(e.col-t.col);return n===1&&a===0||n===0&&a===1}function ue(e){const t=e.length,n=[];for(let o=0;o<t;o++){let i=[];for(let r=0;r<t;r++){const l=e[o][r];if(!l){i.length>=3&&n.push({positions:i,orientation:"horizontal"}),i=[];continue}if(i.length===0)i=[{row:o,col:r}];else{const u=e[i[i.length-1].row][i[i.length-1].col];u&&u.kind===l.kind?i.push({row:o,col:r}):(i.length>=3&&n.push({positions:i,orientation:"horizontal"}),i=[{row:o,col:r}])}}i.length>=3&&n.push({positions:i,orientation:"horizontal"})}for(let o=0;o<t;o++){let i=[];for(let r=0;r<t;r++){const l=e[r][o];if(!l){i.length>=3&&n.push({positions:i,orientation:"vertical"}),i=[];continue}if(i.length===0)i=[{row:r,col:o}];else{const u=e[i[i.length-1].row][i[i.length-1].col];u&&u.kind===l.kind?i.push({row:r,col:o}):(i.length>=3&&n.push({positions:i,orientation:"vertical"}),i=[{row:r,col:o}])}}i.length>=3&&n.push({positions:i,orientation:"vertical"})}for(let o=0;o<t-1;o++)for(let i=0;i<t-1;i++){const r=e[o][i];if(!r)continue;const l=e[o][i+1],u=e[o+1][i],c=e[o+1][i+1];l&&u&&c&&r.kind===l.kind&&r.kind===u.kind&&r.kind===c.kind&&n.push({positions:[{row:o,col:i},{row:o,col:i+1},{row:o+1,col:i},{row:o+1,col:i+1}],orientation:"square"})}if(n.length===0)return[];const a=[],s=new Set;for(let o=0;o<n.length;o++){if(s.has(o))continue;const i=[o],r=new Map,l=new Set;for(;i.length>0;){const d=i.pop();if(s.has(d))continue;s.add(d);const p=n[d];l.add(p.orientation);for(const g of p.positions){const S=B(g);r.has(S)||r.set(S,g)}for(let g=0;g<n.length;g++)s.has(g)||sa(n[d].positions,n[g].positions)&&i.push(g)}const u=Array.from(r.values());let c="horizontal";if(l.size>1)c="mixed";else{const d=l.values().next().value;d&&(c=d)}a.push({positions:u,orientation:c})}return a}function sa(e,t){const n=new Set(e.map(B));return t.some(a=>n.has(B(a)))}function B(e){return`${e.row},${e.col}`}function wt(e,t){for(let n=0;n<e.length;n++)for(let a=0;a<e[n].length;a++)if(e[n][a]){const s={row:n,col:a};t.set(B(s),s)}}function vt(e,t,n,a){const s=B(t);if(a.set(s,t),!n){wt(e,a);return}for(let o=0;o<e.length;o++)for(let i=0;i<e[o].length;i++){const r=e[o][i];if(r&&r.kind===n){const l={row:o,col:i};a.set(B(l),l)}}}function Pn(e,t,n){const a=new Map,s=[],o=new Set(n?[B(n.primary),B(n.secondary)]:[]),i=[];for(const r of t){if(r.positions.length===0)continue;for(const u of r.positions){a.set(B(u),u);const c=e[u.row][u.col];c!=null&&c.special&&se(e,u,c.special,a)}const l=oa(e,r,o);l&&i.push(l)}xt(e,a);for(const r of i)a.delete(B(r.position));for(const r of a.values())e[r.row][r.col]=null;for(const r of i)e[r.position.row][r.position.col]=tt(r.kind,r.special),s.push({...r});return{removed:Array.from(a.values()),createdSpecials:s}}function oa(e,t,n){var u;const a=t.positions.length;if(a<4)return null;let s;t.orientation==="square"?s="block":t.orientation==="mixed"?s="bomb":a>=5?s="color":t.orientation==="horizontal"?s="line-row":s="line-col";const o=ia(t.positions,n);if(!o)return null;const i=e[o.row][o.col],r=((u=e[t.positions[0].row])==null?void 0:u[t.positions[0].col])??null,l=(i==null?void 0:i.kind)??(r==null?void 0:r.kind)??bt[0];return{position:o,special:s,kind:l}}function ia(e,t){if(e.length===0)return null;for(const n of e)if(t.has(B(n)))return n;return e[Math.floor(e.length/2)]}function se(e,t,n,a){var i,r;const s=e.length,o=((i=e[0])==null?void 0:i.length)??0;if(n==="line-row"){for(let l=0;l<o;l++){const u={row:t.row,col:l};a.set(B(u),u)}return}if(n==="line-col"){for(let l=0;l<s;l++){const u={row:l,col:t.col};a.set(B(u),u)}return}if(n==="block"){for(let l=-2;l<=2;l++)for(let u=-2;u<=2;u++){const c=t.row+l,d=t.col+u;if(c<0||c>=s||d<0||d>=o)continue;const p={row:c,col:d};a.set(B(p),p)}return}if(n==="color"){const l=((r=e[t.row])==null?void 0:r[t.col])??null,u=(l==null?void 0:l.kind)??null;vt(e,t,u,a);return}for(let l=-1;l<=1;l++)for(let u=-1;u<=1;u++){const c=t.row+l,d=t.col+u;if(c<0||c>=s||d<0||d>=o)continue;const p={row:c,col:d};a.set(B(p),p)}}function xt(e,t){var s;const n=new Set,a=Array.from(t.values());for(;a.length>0;){const o=a.pop(),i=B(o);if(n.has(i))continue;n.add(i);const r=(s=e[o.row])==null?void 0:s[o.col];if(!(r!=null&&r.special))continue;const l=t.size;if(se(e,o,r.special,t),t.size>l)for(const u of t.values()){const c=B(u);n.has(c)||a.push(u)}}}function ra(e,t,n){var c,d,p,g,S,y,k,C,M;const a=(c=e[t.row])==null?void 0:c[t.col],s=(d=e[n.row])==null?void 0:d[n.col],o=[];if(a!=null&&a.special&&o.push({position:t,special:a.special}),s!=null&&s.special&&o.push({position:n,special:s.special}),o.length===0)return null;const i=K(e),r=new Map;if(o.length===2){const[m,f]=o,E=(g=(p=e[m.position.row])==null?void 0:p[m.position.col])==null?void 0:g.special,T=(y=(S=e[f.position.row])==null?void 0:S[f.position.col])==null?void 0:y.special;if(E==="color"||T==="color")if(E==="color"&&T==="color")wt(e,r);else{const U=E==="color"?m:f,x=U===m?f:m,N=((k=e[x.position.row])==null?void 0:k[x.position.col])??null,w=(N==null?void 0:N.kind)??null;if(vt(e,U.position,w,r),N!=null&&N.special)if(r.set(B(x.position),x.position),w)for(let D=0;D<e.length;D++)for(let j=0;j<e[D].length;j++){const ne=e[D][j];ne&&ne.kind===w&&se(e,{row:D,col:j},N.special,r)}else se(e,x.position,N.special,r)}else if(E==="bomb"&&T==="bomb"||E==="block"&&T==="block")wt(e,r);else{for(const x of o){const N=B(x.position);r.set(N,x.position),se(e,x.position,x.special,r)}const U=[];(E==="bomb"||T==="bomb")&&U.push("bomb"),(E==="block"||T==="block")&&U.push("block");for(const x of o)for(const N of U)(C=e[x.position.row])!=null&&C[x.position.col]&&se(e,x.position,N,r)}}else{const m=o[0];if(m.special==="color"){const E=m.position.row===t.row&&m.position.col===t.col?n:t,T=((M=e[E.row])==null?void 0:M[E.col])??null,z=(T==null?void 0:T.kind)??null;vt(e,m.position,z,r)}else{const f=B(m.position);r.set(f,m.position),se(e,m.position,m.special,r)}}xt(e,r);const l=Array.from(r.values()).filter(m=>{var f;return(f=i[m.row])==null?void 0:f[m.col]});if(l.length===0)return null;for(const{row:m,col:f}of l)e[m][f]=null;Je(e),He(e);const u=K(e);return{removed:l,before:i,after:u}}function Je(e){const t=e.length;for(let n=0;n<t;n++){let a=t-1;for(let s=t-1;s>=0;s--){const o=e[s][n];o&&(s!==a&&(e[a][n]=o,e[s][n]=null),a--)}for(let s=a;s>=0;s--)e[s][n]=null}}function He(e){for(let t=0;t<e.length;t++)for(let n=0;n<e[t].length;n++)e[t][n]||(e[t][n]=tt(kt()))}function $t(e){let t=0;for(;!Lt(e)&&t<En;)la(e),t++;return Lt(e)?e:St(e.length)}function la(e){const t=[];for(const a of e)for(const s of a)s&&t.push(s);for(let a=t.length-1;a>0;a--){const s=Math.floor(Tn()*(a+1)),o=t[a];t[a]=t[s],t[s]=o}let n=0;for(let a=0;a<e.length;a++)for(let s=0;s<e[a].length;s++)e[a][s]=t[n++]}function Lt(e){const t=e.length;for(let n=0;n<t;n++)for(let a=0;a<t;a++){const s={row:n,col:a},o={row:n,col:a+1},i={row:n+1,col:a};if(ee(e,o)&&un(e,s,o)||ee(e,i)&&un(e,s,i))return!0}return!1}function ca(e){const t=e.length;for(let n=0;n<t;n++)for(let a=0;a<t;a++){const s={row:n,col:a},o={row:n,col:a+1},i={row:n+1,col:a};if(ee(e,o)){const r=cn(e,s,o);if(r)return r}if(ee(e,i)){const r=cn(e,s,i);if(r)return r}}return null}function cn(e,t,n){const a=K(e);Oe(a,t,n);const s=ue(a);if(s.length===0)return null;const o=u=>u.some(c=>c.row===t.row&&c.col===t.col||c.row===n.row&&c.col===n.col),i=s.filter(u=>o(u.positions)),r=i.length>0?i:s,l=new Map;for(const u of r)for(const c of u.positions)l.set(B(c),c);return{primary:t,secondary:n,matches:Array.from(l.values())}}function un(e,t,n){if(!ee(e,t)||!ee(e,n))return!1;Oe(e,t,n);const a=ue(e);return Oe(e,t,n),a.length>0}function Oe(e,t,n){const a=e[t.row][t.col];e[t.row][t.col]=e[n.row][n.col],e[n.row][n.col]=a}function xn(e,t,n,a){if(!ee(e,t)||!ee(e,n))return{valid:!1,reason:"out-of-bounds",cascades:[],totalRemoved:0,totalScore:0,frames:[]};if(!aa(t,n))return{valid:!1,reason:"not-adjacent",cascades:[],totalRemoved:0,totalScore:0,frames:[]};const s=K(e);Oe(s,t,n);const o=ra(s,t,n);let i=ue(s);if(!o&&i.length===0&&a.requireMatch)return{valid:!1,reason:"no-match",cascades:[],totalRemoved:0,totalScore:0,frames:[]};const r=[],l=[];let u=0,c=0,d=1;if(o){const y=o.removed.length,k=Math.round(y*Ge*d*Qn);u+=y,c+=k,r.push({removed:o.removed,scoreGain:k,createdSpecials:[]}),l.push({board:o.before,removed:o.removed,cascadeIndex:d,scoreGain:k,createdSpecials:[],type:"special"}),l.push({board:o.after,removed:[],cascadeIndex:d,scoreGain:k,createdSpecials:[],type:"cascade"}),d++,i=ue(s)}let p=s,g=i;for(;g.length>0;){const y=K(p),k=Pn(p,g,{primary:t,secondary:n}),C=k.removed.length+k.createdSpecials.length;u+=C;const M=Math.round(C*Ge*d);c+=M,r.push({removed:k.removed,scoreGain:M,createdSpecials:k.createdSpecials}),l.push({board:y,removed:k.removed,cascadeIndex:d,scoreGain:M,createdSpecials:k.createdSpecials,type:"match"}),Je(p),He(p),l.push({board:K(p),removed:[],cascadeIndex:d,scoreGain:M,createdSpecials:[],type:"cascade"}),g=ue(p),d++}if(u>0){const y=$t(p);y!==p&&(p=y)}for(let y=0;y<e.length;y++)for(let k=0;k<e[y].length;k++)e[y][k]=p[y][k];l.push({board:K(e),removed:[],cascadeIndex:Math.max(1,d-1),scoreGain:0,createdSpecials:[],type:"final"});const S=u>0;return{valid:a.requireMatch?S:!0,reason:S?void 0:"no-match",cascades:r,totalRemoved:u,totalScore:c,frames:l}}function ua(e,t,n){return xn(e,t,n,{requireMatch:!0})}function da(e,t,n){return xn(e,t,n,{requireMatch:!1})}function ma(e,t){var C,M;if(!ee(e,t)||!((C=e[t.row])==null?void 0:C[t.col]))return null;let a=K(e);const s=(M=a[t.row])==null?void 0:M[t.col];if(!s)return null;const o=new Map,i={row:t.row,col:t.col};o.set(B(i),i),s.special&&(se(a,i,s.special,o),xt(a,o));const r=Array.from(o.values()).filter(m=>{var E;return!!((E=a[m.row])==null?void 0:E[m.col])});if(r.length===0)return null;const l=K(a);for(const{row:m,col:f}of r)a[m][f]=null;const u=[],c=[];let d=r.length,p=0,g=1;const S=Math.round(r.length*Ge*g);p+=S,u.push({removed:r,scoreGain:S,createdSpecials:[]}),c.push({board:l,removed:r,cascadeIndex:g,scoreGain:S,createdSpecials:[],type:"special"}),Je(a),He(a),c.push({board:K(a),removed:[],cascadeIndex:g,scoreGain:S,createdSpecials:[],type:"cascade"});let y=a,k=ue(y);for(g++;k.length>0;){const m=K(y),f=Pn(y,k),E=f.removed.length+f.createdSpecials.length;d+=E;const T=Math.round(E*Ge*g);p+=T,u.push({removed:f.removed,scoreGain:T,createdSpecials:f.createdSpecials}),c.push({board:m,removed:f.removed,cascadeIndex:g,scoreGain:T,createdSpecials:f.createdSpecials,type:"match"}),Je(y),He(y),c.push({board:K(y),removed:[],cascadeIndex:g,scoreGain:T,createdSpecials:[],type:"cascade"}),k=ue(y),g++}if(d>0){const m=$t(y);m!==y&&(y=m)}for(let m=0;m<e.length;m++)for(let f=0;f<e[m].length;f++)e[m][f]=y[m][f];return c.push({board:K(e),removed:[],cascadeIndex:Math.max(1,g-1),scoreGain:0,createdSpecials:[],type:"final"}),{cascades:u,totalRemoved:d,totalScore:p,frames:c}}const Ct={hammer:3,"free-switch":3};function dn(e,t){const n=Number(e);return!Number.isFinite(n)||n<0?t:Math.floor(n)}function fa(e){return{hammer:dn(e==null?void 0:e.hammer,Ct.hammer),"free-switch":dn(e==null?void 0:e["free-switch"],Ct["free-switch"])}}const ha={size:Pt,moves:32,targetScore:6500};class pa{constructor(t,n){this.status="loading",this.score=0,this.movesLeft=0,this.jellyGrid=[],this.initialJellyCount=0,this.crateGrid=[],this.initialCrateCount=0,this.highestCombo=0,this.boosters={...Ct},this.level=t,this.config={...ha,...n},this.boardState=St(this.config.size),this.applyLevel(t)}reset(){this.applyLevel(this.level)}getBoard(){return this.boardState}getScore(){return this.score}getMovesLeft(){return this.movesLeft}getTargetScore(){return this.config.targetScore}getHighestCombo(){return this.highestCombo}getMovesUsed(){return Math.max(0,this.config.moves-this.movesLeft)}getScorePerMove(){const t=this.getMovesUsed();return t===0?0:this.score/t}getJellyRemaining(){return this.jellyGrid.reduce((t,n)=>t+n.reduce((a,s)=>a+s,0),0)}hasJellyTarget(){return this.initialJellyCount>0}getJellyGrid(){return this.jellyGrid.map(t=>[...t])}getCrateRemaining(){return this.crateGrid.reduce((t,n)=>t+n.reduce((a,s)=>a+s,0),0)}hasCrateTarget(){return this.initialCrateCount>0}getCrateGrid(){return this.crateGrid.map(t=>[...t])}getBoosters(){return{hammer:this.boosters.hammer,"free-switch":this.boosters["free-switch"]}}canUseBooster(t){return this.status==="playing"&&this.hasBoosterCharges(t)}getLevel(){return this.level}getStarCount(){if(this.config.targetScore<=0)return 0;const t=this.score/this.config.targetScore;return t>=2?3:t>=1.5?2:t>=1?1:0}setLevel(t){this.level=t,this.applyLevel(t)}getStatus(){if(this.status!=="playing")return this.status;const t=this.config.targetScore<=0||this.score>=this.config.targetScore,n=this.getJellyRemaining()===0,a=this.getCrateRemaining()===0;return t&&n&&a?(this.status="won",this.status):(this.movesLeft===0&&(this.status=t&&n&&a?"won":"lost"),this.status)}trySwap(t,n){if(this.status!=="playing")return this.buildFailureFeedback("not-playing");const a=ua(this.boardState,t,n);return a.valid?(this.score+=a.totalScore,this.movesLeft=Math.max(0,this.movesLeft-1),this.highestCombo=Math.max(this.highestCombo,a.cascades.length),this.buildSuccessFeedback(a.cascades,a.frames,a.totalScore)):this.buildFailureFeedback(a.reason??"no-match")}useHammer(t){if(this.status!=="playing")return this.buildFailureFeedback("not-playing");if(!this.hasBoosterCharges("hammer"))return this.buildFailureFeedback("no-charge");if(!this.isPositionInBounds(t))return this.buildFailureFeedback("out-of-bounds");const n=ma(this.boardState,t);return n?(this.spendBooster("hammer"),this.score+=n.totalScore,this.highestCombo=Math.max(this.highestCombo,n.cascades.length),this.buildSuccessFeedback(n.cascades,n.frames,n.totalScore)):this.buildFailureFeedback("invalid-target")}useFreeSwitch(t,n){if(this.status!=="playing")return this.buildFailureFeedback("not-playing");if(!this.hasBoosterCharges("free-switch"))return this.buildFailureFeedback("no-charge");if(!this.isPositionInBounds(t)||!this.isPositionInBounds(n))return this.buildFailureFeedback("out-of-bounds");if(!this.positionsAreAdjacent(t,n))return this.buildFailureFeedback("not-adjacent");const a=da(this.boardState,t,n);return this.spendBooster("free-switch"),this.score+=a.totalScore,this.highestCombo=Math.max(this.highestCombo,a.cascades.length),this.buildSuccessFeedback(a.cascades,a.frames,a.totalScore,a.reason)}applyLevel(t){const n=t.layout?t.layout.length:t.boardSize??this.config.size;this.config={size:n,moves:t.moves,targetScore:t.targetScore,boosters:this.config.boosters},this.boardState=t.layout?this.boardFromLayout(t.layout):St(n),this.boardState=$t(this.boardState),this.jellyGrid=this.cloneJellyLayout(n,t.jellyLayout),this.initialJellyCount=this.getJellyRemaining(),this.crateGrid=this.cloneCrateLayout(n,t.crateLayout),this.initialCrateCount=this.getCrateRemaining(),this.status="playing",this.score=0,this.movesLeft=this.config.moves,this.highestCombo=0,this.boosters=fa(this.config.boosters)}buildFailureFeedback(t){return{success:!1,reason:t,cascades:[],scoreGain:0,movesLeft:this.movesLeft,status:this.getStatus(),totalScore:this.score,frames:[],clearedJelly:0,jellyRemaining:this.getJellyRemaining(),clearedJellyPositions:[],clearedCrate:0,crateRemaining:this.getCrateRemaining(),clearedCratePositions:[]}}buildSuccessFeedback(t,n,a,s){const o=this.applyJellyFromCascades(t),i=this.applyCrateFromCascades(t),r=this.getJellyRemaining(),l=this.getCrateRemaining(),u=this.getStatus();return{success:!0,reason:s,cascades:t,scoreGain:a,movesLeft:this.movesLeft,status:u,totalScore:this.score,frames:n,clearedJelly:o.cleared,jellyRemaining:r,clearedJellyPositions:o.positions,clearedCrate:i.cleared,crateRemaining:l,clearedCratePositions:i.positions}}hasBoosterCharges(t){return(this.boosters[t]??0)>0}spendBooster(t){this.boosters[t]>0&&(this.boosters[t]-=1)}isPositionInBounds(t){const n=this.boardState.length;return t.row>=0&&t.col>=0&&t.row<n&&t.col<n}positionsAreAdjacent(t,n){const a=Math.abs(t.row-n.row),s=Math.abs(t.col-n.col);return a===1&&s===0||a===0&&s===1}boardFromLayout(t){var a;const n=ta(t);if(n.length!==((a=n[0])==null?void 0:a.length))throw new Error("Layouts harus berbentuk kotak untuk saat ini");return n}cloneJellyLayout(t,n){if(!n)return this.createEmptyGrid(t);if(n.length!==t)throw new Error("Jelly layout harus memiliki jumlah baris yang sama dengan board");return n.map(a=>{if(a.length!==t)throw new Error("Setiap baris jelly layout harus memiliki panjang yang sama dengan board");return a.map(s=>{const o=Number(s??0);return!Number.isFinite(o)||o<=0?0:Math.floor(o)})})}createEmptyGrid(t){return Array.from({length:t},()=>Array(t).fill(0))}cloneCrateLayout(t,n){if(!n)return this.createEmptyGrid(t);if(n.length!==t)throw new Error("Crate layout harus memiliki jumlah baris yang sama dengan board");return n.map(a=>{if(a.length!==t)throw new Error("Setiap baris crate layout harus memiliki panjang yang sama dengan board");return a.map(s=>{const o=Number(s??0);return!Number.isFinite(o)||o<=0?0:Math.floor(o)})})}applyJellyFromCascades(t){var o;if(!this.hasJellyTarget()||t.length===0)return{cleared:0,positions:[]};const n=new Map;for(const i of t)for(const r of i.removed){const l=this.positionKey(r),u=n.get(l);u?u.count+=1:n.set(l,{position:{...r},count:1})}let a=0;const s=[];for(const{position:i,count:r}of n.values()){const{row:l,col:u}=i,c=((o=this.jellyGrid[l])==null?void 0:o[u])??0;if(c<=0)continue;const d=Math.min(c,r);d<=0||(this.jellyGrid[l][u]=c-d,a+=d,this.jellyGrid[l][u]===0&&s.push({...i}))}return{cleared:a,positions:s}}applyCrateFromCascades(t){var o;if(!this.hasCrateTarget()||t.length===0)return{cleared:0,positions:[]};const n=new Map;for(const i of t)for(const r of i.removed){const l=this.positionKey(r),u=n.get(l);u?u.count+=1:n.set(l,{position:{...r},count:1})}let a=0;const s=[];for(const{position:i,count:r}of n.values()){const{row:l,col:u}=i,c=((o=this.crateGrid[l])==null?void 0:o[u])??0;if(c<=0)continue;const d=Math.min(c,r);d<=0||(this.crateGrid[l][u]=c-d,a+=d,this.crateGrid[l][u]===0&&s.push({...i}))}return{cleared:a,positions:s}}positionKey(t){return`${t.row},${t.col}`}}const Ue=[{id:1,name:"Pelatihan Manis",description:"Cocokkan permen dan raih target pertama Anda.",targetScore:6500,moves:32},{id:2,name:"Pola Bergantian",description:"Cascade lebih panjang mulai muncul. Bersihkan jelly!",targetScore:8200,moves:30,boardSize:8,jellyLayout:[[1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1]]},{id:3,name:"Ronde Pemanasan",description:"Perlu rencana untuk mencapai skor tinggi sambil memecah peti.",targetScore:12e3,moves:28,crateLayout:[[0,0,0,1,1,0,0,0,0],[0,0,1,1,1,1,0,0,0],[0,1,1,1,1,1,1,0,0],[1,1,1,2,2,1,1,1,0],[1,1,1,2,3,2,1,1,1],[1,1,1,2,2,1,1,1,0],[0,1,1,1,1,1,1,0,0],[0,0,1,1,1,1,0,0,0],[0,0,0,1,1,0,0,0,0]]}],Mt=100,mn=9,fn=["Festival Permen","Gelombang Lollipop","Safari Jelly","Resonansi Karamel","Badai Gula","Lintasan Marshmallow","Koridor Nougat","Labirin Praline","Oasis Gummy","Spiral Sirup","Galaksi Licorice","Ekspedisi Toffee"],hn=["Ritme pemanasan—cocok untuk membangun rasa percaya.","Papan mulai menuntut fokus ekstra.","Strategi menengah: kelola ruang dan langkah secara seimbang.","Kesempatan spesial makin berharga, jangan sia-siakan.","Tekanan tinggi: utamakan gerakan dengan imbalan terbaik.","Tantangan ahli: kombinasikan booster dan spesial.","Tempo cepat wajib dijaga, jangan biarkan papan buntu.","Satu kesalahan bisa mahal. Baca pola sebelum bergerak.","Mode veteran: gunakan setiap tile spesial seefektif mungkin.","Badai terakhir! Hanya eksekusi sempurna yang akan menang."],pn=[e=>({description:ae("score",e)}),e=>{const t=e.baseSize,n=e.id>=60?2:1;return{description:ae("jelly-ring",e),jellyLayout:Re(t,n,Me(e))}},e=>{const t=e.baseSize,n=e.id>=50?1:0;return{description:ae("jelly-cross",e),jellyLayout:gt(t,n,Me(e))}},e=>{const t=e.difficultyTier>=6,n=t?e.baseSize+1:e.baseSize,a=Math.min(4,2+e.intensity+Math.floor(e.difficultyTier/3));return{boardSize:t?n:void 0,description:ae("jelly-diamond",e),jellyLayout:gn(n,a,Me(e))}},e=>{const t=e.baseSize,n=e.id>=70?2:1;return{description:ae("crate-ring",e),crateLayout:Re(t,n,Ee(e))}},e=>{const t=e.baseSize,n=e.id>=55?1:0;return{description:ae("crate-cross",e),crateLayout:gt(t,n,Ee(e))}},e=>{const t=e.id>=34,n=t?e.baseSize-1:e.baseSize,a=Math.min(4,3+e.intensity),s=e.id>=80?2:1;return{boardSize:t?n:void 0,description:ae("mixed-jelly-crate",e),jellyLayout:Re(n,s,Me(e)),crateLayout:gn(n,a,Ee(e))}},e=>{const t=e.baseSize,n=t<=8?1:0,a=Sa(t,1+e.intensity,Math.max(0,Ee(e)-1)),s=Re(t,1,Ee(e));return{description:ae("mixed-crate-jelly",e),jellyLayout:gt(t,n,Me(e)),crateLayout:wa(t,s,a)}}],v=[...Ue,...ga()];if(v.length!==Mt)throw new Error(`Konfigurasi level tidak lengkap: ${v.length} dari ${Mt}`);function ga(){const e=[];for(let t=Ue.length+1;t<=Mt;t++){const n=Math.floor((t-1)/10),a=Math.floor((t-1)/25),s=(t-Ue.length-1)%pn.length,o=pn[s],r=o({id:t,baseSize:mn,difficultyTier:n,intensity:a}),l={id:t,name:ya(t),description:r.description,targetScore:ba(t,n,a),moves:ka(t,a)};r.boardSize&&r.boardSize!==mn&&(l.boardSize=r.boardSize),r.jellyLayout&&(l.jellyLayout=r.jellyLayout),r.crateLayout&&(l.crateLayout=r.crateLayout),e.push(l)}return e}function ya(e){const t=(e-Ue.length-1)%fn.length,n=e.toString().padStart(2,"0");return`${fn[t]} ${n}`}function ae(e,t){const n=hn[Math.min(hn.length-1,t.difficultyTier)];switch(e){case"score":return`Kejar skor murni dengan memanfaatkan combo panjang. ${n}`;case"jelly-ring":return`Bersihkan jelly yang mengunci tepi papan sebelum langkah habis. ${n}`;case"jelly-cross":return`Jelly membentuk salib di tengah—buat spesial garis untuk membersihkannya cepat. ${n}`;case"jelly-diamond":return`Jelly bertumpuk di pusat papan. Fokuskan ledakan area di sana. ${n}`;case"crate-ring":return`Peti mengelilingi papan. Hancurkan lapisan luar lalu kejar skor. ${n}`;case"crate-cross":return`Peti tebal menahan jalur utama. Pecahkan dengan spesial dan combo. ${n}`;case"mixed-jelly-crate":return`Gabungan jelly dan peti menunggu di pusat. Seimbangkan skor dan pembersihan. ${n}`;case"mixed-crate-jelly":return`Jelly licin menempel di jalur silang sementara peti menjaga sudut. Rencanakan gerakan area. ${n}`}}function ba(e,t,n){const s=1400+n*150,o=t*2200+n*900;return 6500+(e-1)*s+o}function ka(e,t){const n=Math.floor((e-1)/6)+t;return Math.max(18,32-n)}function Me(e){return Math.min(3,1+Math.floor(e.difficultyTier/3))}function Ee(e){return Math.min(3,1+Math.floor(e.difficultyTier/2))}function Be(e){return Array.from({length:e},()=>Array(e).fill(0))}function Re(e,t,n){const a=Math.max(1,Math.min(t,Math.floor(e/2))),s=Be(e);for(let o=0;o<e;o++)for(let i=0;i<e;i++)(o<a||i<a||o>=e-a||i>=e-a)&&(s[o][i]=n);return s}function gt(e,t,n){const a=Math.max(0,Math.min(t,Math.floor(e/2))),s=Be(e),o=Math.floor((e-1)/2),i=e%2===0?o+1:o;for(let r=0;r<e;r++)for(let l=o-a;l<=i+a;l++)l>=0&&l<e&&(s[r][l]=Math.max(s[r][l],n));for(let r=0;r<e;r++)for(let l=o-a;l<=i+a;l++)l>=0&&l<e&&(s[l][r]=Math.max(s[l][r],n));return s}function gn(e,t,n){const a=Be(e),s=Math.max(0,Math.min(t,e)),o=(e-1)/2;for(let i=0;i<e;i++)for(let r=0;r<e;r++)Math.abs(i-o)+Math.abs(r-o)<=s&&(a[i][r]=n);return a}function Sa(e,t,n){const a=Be(e),s=Math.max(1,Math.min(t,Math.floor(e/2)));for(let o=0;o<s;o++)for(let i=0;i<s;i++)a[o][i]=n,a[o][e-1-i]=n,a[e-1-o][i]=n,a[e-1-o][e-1-i]=n;return a}function wa(e,...t){const n=Be(e);for(const a of t)if(a){if(a.length!==e)throw new Error("Layout harus memiliki tinggi yang sama dengan ukuran papan");for(let s=0;s<e;s++){const o=a[s];if(!o||o.length!==e)throw new Error("Layout harus berbentuk persegi sesuai ukuran papan");for(let i=0;i<e;i++){const r=Number(o[i]??0);r>0&&(n[s][i]=Math.max(n[s][i],Math.floor(r)))}}}return n}const Ke=[{id:"daily-score",title:"Skor Harian",description:"Capai total skor 25.000 poin hari ini.",type:"score",target:25e3,reward:25,timeframe:"daily"},{id:"daily-special",title:"Special Hunter",description:"Buat 8 special candy dalam satu hari.",type:"special",target:8,reward:20,timeframe:"daily"},{id:"weekly-jelly",title:"Pembersih Jelly",description:"Bersihkan 150 lapis jelly dalam seminggu.",type:"jelly",target:150,reward:80,timeframe:"weekly"},{id:"weekly-crate",title:"Pembuka Peti",description:"Pecahkan 100 lapis crate minggu ini.",type:"crate",target:100,reward:75,timeframe:"weekly"}];function va(){const e={},t=new Date().toISOString();for(const n of Ke)e[n.id]={id:n.id,progress:0,completed:!1,claimed:!1};return{missions:Ke,progress:e,generatedAt:t}}function La(e,t){const n={missions:e.missions,progress:{...e.progress},generatedAt:e.generatedAt};for(const a of e.missions){const s=t[a.type];if(!s||s<=0)continue;const o=n.progress[a.id];if(!o||o.completed)continue;const i=Math.min(a.target,o.progress+s);n.progress[a.id]={...o,progress:i,completed:i>=a.target}}return n}function Ca(e,t){const n=e.progress[t];return!n||!n.completed||n.claimed?e:{missions:e.missions,progress:{...e.progress,[t]:{...n,claimed:!0}},generatedAt:e.generatedAt}}function Ma(e,t){return`${e.progress}/${t.target}`}function Ea(e,t=new Date){const n=new Date(e);return n.getUTCFullYear()!==t.getUTCFullYear()||n.getUTCMonth()!==t.getUTCMonth()||n.getUTCDate()!==t.getUTCDate()}function Ta(e,t=new Date){const n=new Date(e),a=yn(n),s=yn(t);return n.getUTCFullYear()!==t.getUTCFullYear()||a!==s}function yn(e){const t=new Date(e.valueOf()),n=(e.getUTCDay()+6)%7;t.setUTCDate(t.getUTCDate()-n+3);const a=new Date(Date.UTC(t.getUTCFullYear(),0,4)),s=t.valueOf()-a.valueOf();return 1+Math.round(s/(7*24*60*60*1e3))}function $n(e,t=new Date){const n=Ea(e.generatedAt,t),a=Ta(e.generatedAt,t);if(!n&&!a)return e;const s={missions:e.missions,progress:{...e.progress},generatedAt:t.toISOString()};for(const o of e.missions)(o.timeframe==="daily"?n:a)&&(s.progress[o.id]={id:o.id,progress:0,completed:!1,claimed:!1});return s}const yt={softCurrency:0,lastUpdated:new Date().toISOString(),levelProgress:{}};function Pa(e){try{const t=window.localStorage.getItem(e);if(!t)return{...yt};const n=JSON.parse(t);return Number.isFinite((n==null?void 0:n.softCurrency)??NaN)?{softCurrency:Math.max(0,Math.floor(n.softCurrency)),lastUpdated:n.lastUpdated??new Date().toISOString(),levelProgress:Nt(n.levelProgress??{})}:{...yt}}catch(t){return console.warn("Gagal memuat profil pemain",t),{...yt}}}function xa(e,t){try{window.localStorage.setItem(e,JSON.stringify(t))}catch(n){console.warn("Gagal menyimpan profil pemain",n)}}function $a(e,t){return!Number.isFinite(t)||t<=0?e:{softCurrency:e.softCurrency+Math.floor(t),lastUpdated:new Date().toISOString(),levelProgress:Nt(e.levelProgress??{})}}function nt(e,t){const n={...Nt(e.levelProgress??{})};let a=!1;for(let s=1;s<=t;s++)n[s]||(n[s]={bestScore:0,bestStars:0,bestCombo:0,bestEfficiency:0,lastScore:0,lastCombo:0,lastEfficiency:0,unlocked:s===1},a=!0);return a?{softCurrency:e.softCurrency,lastUpdated:new Date().toISOString(),levelProgress:n}:{...e,levelProgress:n}}function Na(e,t,n,a,s,o,i){const r=nt(e,s),l={...r.levelProgress},c={...l[t]};let d=!1,p=!1;c.unlocked||(c.unlocked=!0,d=!0);const g=Math.max(0,Math.min(3,Math.floor(n))),S=Math.max(0,Math.floor(a)),y=Math.max(0,Math.floor(o)),k=i>0?Number(i):0;c.lastScore=S,c.lastCombo=y,c.lastEfficiency=k,d=!0,g>c.bestStars&&(c.bestStars=g,p=!0,d=!0),S>c.bestScore&&(c.bestScore=S,d=!0),y>c.bestCombo&&(c.bestCombo=y,d=!0),k>c.bestEfficiency&&(c.bestEfficiency=k,d=!0),d&&(l[t]=c);const C=[];if(g>0){const M=t+1;if(M<=s){const m=l[M];m!=null&&m.unlocked||(l[M]={bestScore:(m==null?void 0:m.bestScore)??0,bestStars:(m==null?void 0:m.bestStars)??0,bestCombo:(m==null?void 0:m.bestCombo)??0,bestEfficiency:(m==null?void 0:m.bestEfficiency)??0,lastScore:(m==null?void 0:m.lastScore)??0,lastCombo:(m==null?void 0:m.lastCombo)??0,lastEfficiency:(m==null?void 0:m.lastEfficiency)??0,unlocked:!0},C.push(M),d=!0)}}return d?{profile:{softCurrency:r.softCurrency,lastUpdated:new Date().toISOString(),levelProgress:l},unlockedLevels:C,improvedStars:p}:{profile:r,unlockedLevels:C,improvedStars:p}}function Nt(e){const t={};for(const[n,a]of Object.entries(e)){const s=Number(n);Number.isFinite(s)&&(t[s]={bestScore:Math.max(0,Math.floor((a==null?void 0:a.bestScore)??0)),bestStars:Math.max(0,Math.min(3,Math.floor((a==null?void 0:a.bestStars)??0))),bestCombo:Math.max(0,Math.floor((a==null?void 0:a.bestCombo)??0)),bestEfficiency:Math.max(0,Number.isFinite(a==null?void 0:a.bestEfficiency)?Number(a==null?void 0:a.bestEfficiency):0),lastScore:Math.max(0,Math.floor((a==null?void 0:a.lastScore)??0)),lastCombo:Math.max(0,Math.floor((a==null?void 0:a.lastCombo)??0)),lastEfficiency:Math.max(0,Number.isFinite(a==null?void 0:a.lastEfficiency)?Number(a==null?void 0:a.lastEfficiency):0),unlocked:!!(a!=null&&a.unlocked)})}return t}const Ba={match:320,cascade:260,special:360,final:160},ja=10,De=28,bn=160,Nn=260,Ia=7e3,Aa={berry:{emoji:"🐻",name:"Beruang Berry",background:"linear-gradient(135deg, #fbc2eb, #a6c1ee)",text:"#0f172a"},candy:{emoji:"🐰",name:"Kelinci Candy",background:"linear-gradient(135deg, #fda085, #f6d365)",text:"#0f172a"},citrus:{emoji:"🐤",name:"Anak Ayam Citrus",background:"linear-gradient(135deg, #f6d365, #fda085)",text:"#0f172a"},gem:{emoji:"🦊",name:"Rubah Gem",background:"linear-gradient(135deg, #5ee7df, #b490ca)",text:"#0f172a"},star:{emoji:"🐱",name:"Kucing Star",background:"linear-gradient(135deg, #cfd9df, #e2ebf0)",text:"#0f172a"},heart:{emoji:"🐶",name:"Anjing Heart",background:"linear-gradient(135deg, #fcb69f, #ffecd2)",text:"#0f172a"}},Ra={"line-row":"➡️","line-col":"⬇️",bomb:"💣",block:"🧊",color:"🌈"},$e={hammer:{icon:"🔨",label:"Lollipop Hammer",description:"Hancurkan satu tile apa pun secara instan."},"free-switch":{icon:"🔁",label:"Free Switch",description:"Tukar dua tile bertetangga tanpa mengurangi langkah."}},Bn="crush-rush-missions",jn="crush-rush-profile";let R=0;const h=new pa(v[R]),In=document.getElementById("app");if(!In)throw new Error("Root container #app tidak ditemukan");const me=document.createElement("div"),Bt=document.createElement("div"),An=document.createElement("div"),jt=document.createElement("header"),It=document.createElement("h1"),At=document.createElement("p"),_e=document.createElement("div"),_=document.createElement("div"),at=document.createElement("div"),pe=document.createElement("div"),Te=document.createElement("div"),Pe=document.createElement("div"),xe=document.createElement("div"),fe=document.createElement("div"),Rt=document.createElement("div"),st=document.createElement("button"),ke=document.createElement("div"),ot=document.createElement("button"),it=document.createElement("button"),X=document.createElement("div"),qe=document.createElement("h3"),Dt=document.createElement("p"),ce=document.createElement("ul"),rt=document.createElement("button"),V=document.createElement("div"),Y=document.createElement("div"),ze=document.createElement("ul"),Ft=document.createElement("div"),Et={hammer:document.createElement("span"),"free-switch":document.createElement("span")},Ve={hammer:wn("hammer",Et.hammer),"free-switch":wn("free-switch",Et["free-switch"])},lt=document.createElement("button"),Gt=document.createElement("div"),Jt=document.createElement("div"),Ht=document.createElement("div"),Ye=document.createElement("div"),je=document.createElement("div"),Ot=document.createElement("div"),Ut=document.createElement("h1"),Kt=document.createElement("p"),_t=document.createElement("div"),qt=document.createElement("span"),zt=document.createElement("span"),Vt=document.createElement("span"),Yt=document.createElement("span"),ge=document.createElement("p"),Wt=document.createElement("div"),ct=document.createElement("button"),Ie=document.createElement("button"),Xt=document.createElement("p"),Zt=document.createElement("div"),Qt=document.createElement("h2"),en=document.createElement("div"),ut=document.createElement("div"),dt=document.createElement("div"),he=document.createElement("div"),We=document.createElement("div");let G=null,b=v[R].description??"Cocokkan tiga permen atau lebih!",I=null,te=!1,q=!0,re=!1,O=R,A=gs(),H=nt(Pa(jn),v.length);rn();let J=null,ye=!1,Xe=!1,de=!1,Se="menu",Tt="loading",Fe=!1,oe=null,ie=null,Q=null,be=null,W=null,$=null,P=null;me.className="game-shell";Bt.className="background-layer";An.className="background-particles";jt.className="game-header";It.className="game-title";It.textContent="Crush Rush";At.className="game-subtitle";At.textContent="Petualangan Match-3 Seru Bersama Sahabat Hewan";_e.className="hud";_.className="board";at.className="status-banner";pe.className="status-banner hidden";Te.className="state-message";Pe.className="state-stars";xe.className="state-detail";fe.className="state-actions";pe.append(Te,Pe,xe,fe);Rt.className="hud";st.className="primary";st.textContent="Mulai Ulang";lt.className="ghost";lt.textContent="Ke Menu Utama";X.className="session-summary hidden";V.className="session-confetti";qe.textContent="Hasil Sesi";Dt.className="session-summary-body";ce.className="session-summary-list";rt.className="ghost";rt.textContent="Tutup";X.append(V,qe,Dt,ce,rt);Y.className="mission-toast hidden";ze.className="mission-toast-list";Y.append(ze);Ft.className="booster-bar";Ft.append(Ve.hammer,Ve["free-switch"]);ke.className="tutorial-overlay";ke.innerHTML=`
  <div>
    <h3>Selamat datang di Crush Rush!</h3>
    <p>Tukarkan dua permen bertetangga untuk membentuk garis tiga atau lebih dan kumpulkan skor.</p>
    <p><strong>Klik di mana saja</strong> untuk memulai level pertama.</p>
  </div>
`;ot.className="primary";ot.textContent="Level Berikutnya";it.className="ghost";it.textContent="Ulangi Level";Gt.className="play-area";Jt.className="mission-panel";Ht.className="mission-header";Ht.textContent="🗒️ Misi";Ye.className="mission-list";Jt.append(Ht,Ye);Gt.append(_,Jt);jt.append(It,At);je.className="main-menu";Ot.className="menu-header";Ut.className="menu-title";Ut.textContent="Crush Rush";Kt.className="menu-subtitle";Kt.textContent="Rencanakan langkahmu, kumpulkan combo, dan raih skor bintang!";_t.className="menu-stats";ge.className="menu-mission-summary";ge.textContent="Misi aktif siap dijalankan. Masuk ke permainan untuk progres lebih lanjut.";Wt.className="menu-actions";ct.className="primary";ct.textContent="Mulai Petualangan";Ie.className="ghost";Ie.textContent="Lanjutkan Permainan";Xt.className="menu-footer-hint";Xt.textContent="Kumpulkan bintang untuk membuka misi dan hadiah baru.";qt.textContent="-";zt.textContent="-";Vt.textContent="-";Yt.textContent="-";const Da=mt("Level Saat Ini",qt),Fa=mt("Target Skor",zt),Ga=mt("Langkah Tersedia",Vt),Ja=mt("Koin",Yt);_t.append(Da,Fa,Ga,Ja);Ot.append(Ut,Kt);Zt.className="menu-levels";Qt.className="menu-levels-title";Qt.textContent="Pilih Level";en.className="menu-levels-content";ut.className="menu-level-map";ut.setAttribute("aria-label","Peta level");dt.className="menu-map-scroll";he.className="menu-map-path";We.className="menu-level-detail";dt.append(he);ut.append(dt);en.append(ut,We);Zt.append(Qt,en);Wt.append(ct,Ie);je.append(Ot,_t,Zt,ge,Wt,Xt);ke.addEventListener("click",()=>{F(),q=!1,re=!0,b="Pilih dua permen bertetangga untuk ditukar.",L()});st.addEventListener("click",()=>{F(),Ce(),ht(),h.reset(),G=null,$=null,P=null,te=!1,q=R===0&&!re,b=q?"Baca instruksi lalu klik untuk mulai.":"Level dimulai ulang.",!q&&h.hasJellyTarget()&&(b+=" Bersihkan semua jelly!"),!q&&h.hasCrateTarget()&&(b+=" Pecahkan semua crate!"),L()});ot.addEventListener("click",()=>{F(),Vn()&&ve(R+1,{message:"Level baru dimulai. Kejar skor terbaik!",showTutorial:!1})});it.addEventListener("click",()=>{F(),ve(R,{message:"Coba lagi. Pelajari pola cascade!",showTutorial:!1})});ct.addEventListener("click",()=>{F(),ve(0,{message:"Level pertama dimulai. Bentuk combo terbaikmu!",showTutorial:!re}),Ne()});Ie.addEventListener("click",()=>{F(),Ne()});lt.addEventListener("click",()=>{F(),Rn()});rt.addEventListener("click",()=>{F(),Fn()});Rt.append(st,Ft,lt);me.append(jt,_e,Gt,at,pe,Rt,ke);me.prepend(Bt);Bt.append(An);In.append(je,me,X,Y);me.classList.add("hidden");window.crushRush={debugBoard(){return{board:structuredClone(h.getBoard()),jelly:h.getJellyGrid(),crate:h.getCrateGrid()}},skipTutorial(){re=!0,q=!1,L()},loadLevel(e){ve(e,{showTutorial:e===0&&!re})}};function ve(e,t){if(e<0||e>=v.length){console.warn("Level index di luar jangkauan",e);return}if(O=e,!ps(e)){const s=v[e],o=v[e-1];b=o?`Level ${s.id} terkunci. Selesaikan Level ${o.id} terlebih dahulu.`:"Level ini belum tersedia.",Le();return}ht(),Ce(),R=e;const n=v[R];h.setLevel(n),G=null,$=null,P=null,te=!1,Tt=h.getStatus(),q=(t==null?void 0:t.showTutorial)??(e===0&&!re),q?b="Ikuti instruksi pada overlay untuk memulai.":(b=(t==null?void 0:t.message)??n.description??"Selamat bermain.",h.hasJellyTarget()&&(b+=" Bersihkan semua jelly!"),h.hasCrateTarget()&&(b+=" Pecahkan semua crate!")),L(),we()}function Ne(){if(Se==="game"){L(),we();return}Ce(),Se="game",je.classList.add("hidden"),me.classList.remove("hidden"),$=null,P=null,L(),we()}function Rn(){ht(),ft(),os(),ye=!1,de=!1,$=null,P=null,Se="menu",me.classList.add("hidden"),je.classList.remove("hidden"),Ce(),Fn(),O=R,Le()}function Le(){const e=v[O]??v[R];if(!e)return;const t=O===R,n=t?h.getTargetScore():e.targetScore,a=t?h.getMovesLeft():e.moves;qt.textContent=`Level ${e.id} – ${e.name}`,zt.textContent=n.toLocaleString("id-ID"),Vt.textContent=`${a} / ${e.moves}`,Yt.textContent=H.softCurrency.toLocaleString("id-ID"),Ha();const s=A.missions.length,o=A.missions.filter(r=>{const l=A.progress[r.id];return(l==null?void 0:l.completed)??!1}).length,i=A.missions.filter(r=>{const l=A.progress[r.id];return!!(l!=null&&l.completed)&&!(l!=null&&l.claimed)}).length;s===0?ge.textContent="Belum ada misi aktif. Selesaikan level untuk membuka misi baru.":i>0?ge.textContent=`${i} misi siap diklaim! Masuk ke permainan untuk mengambil hadiah.`:ge.textContent=`Misi aktif: ${o}/${s} selesai.`,Ie.disabled=Se==="game"}function Ha(){Ua(),Oa()}function Oa(){We.innerHTML="";const e=v[O];if(!e)return;const t=H.levelProgress[e.id],n=(t==null?void 0:t.unlocked)??!1,a=O===R,s=e.boardSize??Pt,o=Sn(e.jellyLayout),i=Sn(e.crateLayout),r=o>0,l=i>0,u=document.createElement("div");u.className="level-detail-header";const c=document.createElement("span");c.className="level-detail-badge",c.textContent=`Level ${e.id}`;const d=document.createElement("h3");d.className="level-detail-title",d.textContent=e.name,u.append(c,d);const p=document.createElement("p");if(p.className="level-detail-description",n)p.textContent=e.description??"Capai target skor untuk memenangkan level ini.",r&&(p.textContent+=" Jangan lupakan jelly yang tersembunyi."),l&&(p.textContent+=" Pecahkan peti untuk membuka ruang baru.");else{const w=v[O-1],D=w?`Selesaikan Level ${w.id} untuk membuka.`:"Level ini belum tersedia.";p.textContent=D}const g=document.createElement("ul");g.className="level-detail-metrics",[{label:"🎯 Target Skor",value:(a?h.getTargetScore():e.targetScore).toLocaleString("id-ID")},{label:"🪄 Langkah",value:`${a?h.getMovesLeft():e.moves} / ${e.moves}`},{label:"🧭 Ukuran Papan",value:`${s} × ${s}`}].forEach(w=>{const D=document.createElement("li"),j=document.createElement("span");j.className="metric-label",j.textContent=w.label;const ne=document.createElement("strong");ne.textContent=w.value,D.append(j,ne),g.append(D)});const y=document.createElement("p");y.className="level-detail-objectives-heading",y.textContent="Tujuan Level";const k=document.createElement("ul");k.className="level-detail-objectives";const C=[];if(r){const w=`🍮 Bersihkan ${o.toLocaleString("id-ID")} tile jelly.`;C.push(w)}if(l){const w=`📦 Hancurkan ${i.toLocaleString("id-ID")} peti yang menghalangi.`;C.push(w)}C.push("⭐ Capai target skor yang ditentukan."),C.forEach(w=>{const D=document.createElement("li");D.textContent=w,k.append(D)});const M=document.createElement("div");M.className="level-detail-progress";const m=document.createElement("h4");m.className="level-detail-progress-title",m.textContent="Rekor Permainan",M.append(m);const f=document.createElement("ul");f.className="level-detail-progress-list";const E=(t==null?void 0:t.bestStars)??0,T=(t==null?void 0:t.bestScore)??0,z=(t==null?void 0:t.bestCombo)??0,U=(t==null?void 0:t.bestEfficiency)??0;if(E>0||T>0||z>0||U>0){const w=document.createElement("li");if(w.textContent=`⭐ Bintang terbaik: ${et(E)}`,f.append(w),T>0){const j=document.createElement("li");j.textContent=`🏆 Skor terbaik: ${T.toLocaleString("id-ID")}`,f.append(j)}if(z>0){const j=document.createElement("li");j.textContent=`⚡ Combo terbaik: ${z}`,f.append(j)}if(U>0){const j=document.createElement("li");j.textContent=`🎯 Skor/Langkah terbaik: ${U.toFixed(2)}`,f.append(j)}const D=(t==null?void 0:t.lastScore)??0;if(D>0){const j=(t==null?void 0:t.lastCombo)??0,ne=(t==null?void 0:t.lastEfficiency)??0,ln=document.createElement("li"),Xn=j>0?j.toString():"-",Zn=ne>0?ne.toFixed(2):"-";ln.textContent=`⌛ Terakhir • Skor: ${D.toLocaleString("id-ID")} • Combo: ${Xn} • Skor/Langkah: ${Zn}`,f.append(ln)}M.append(f)}else{const w=document.createElement("p");w.className="level-detail-progress-empty",w.textContent="Belum ada catatan. Mainkan level ini untuk mengumpulkan bintang dan skor.",M.append(w)}const x=document.createElement("div");x.className="level-detail-actions";const N=document.createElement("button");if(N.className="primary",N.textContent=a?"Lanjutkan Level Ini":"Mainkan Level Ini",N.disabled=!n,N.addEventListener("click",()=>{Dn()}),x.append(N),a){const w=document.createElement("button");w.className="ghost",w.textContent="Mulai Ulang Level",w.addEventListener("click",()=>{F(),ve(O,{showTutorial:O===0&&!re,message:"Level dimulai ulang."}),Ne()}),x.append(w)}else if(!n){const w=document.createElement("p");w.className="menu-level-detail-locked-note";const D=v[O-1];w.textContent=D?`Butuh menyelesaikan Level ${D.id} terlebih dahulu.`:"Level ini belum tersedia.",x.append(w)}We.append(u,p,g,y,k,M,x)}function kn(e){if(e<0||e>=v.length)return;const t=v[e],n=H.levelProgress[t.id];n!=null&&n.unlocked&&(O=e,F(),Le())}function Dn(){const e=O;if(e<0||e>=v.length)return;const t=v[e],n=H.levelProgress[t.id];if(n!=null&&n.unlocked){if(F(),e===R){Ne();return}ve(e,{showTutorial:e===0&&!re,message:t.description??"Selamat bermain."}),Ne()}}function Sn(e){return e?e.reduce((t,n)=>t+n.reduce((a,s)=>{const o=Number(s??0);return a+(Number.isFinite(o)&&o>0?1:0)},0),0):0}function Ua(){he.innerHTML="";const e=v.length;for(let t=0;t<e;t++){const n=v[t],a=H.levelProgress[n.id],s=(a==null?void 0:a.unlocked)??!1,o=((a==null?void 0:a.bestStars)??0)>0,i=t%2===0?"left":"right",r=t===O,l=document.createElement("div");l.className="menu-map-row",t<e-1&&l.classList.add("has-next"),r&&l.classList.add("selected"),l.dataset.align=i;const u=i==="left"?"-80px":i==="right"?"80px":"0px";l.style.setProperty("--map-offset",u);const c=document.createElement("button");c.className="map-node",c.type="button",c.setAttribute("aria-pressed",r?"true":"false"),c.disabled=!s,s||c.classList.add("locked"),o&&c.classList.add("completed"),s&&!o&&t!==R&&c.classList.add("ready"),t===R&&c.classList.add("current"),r&&c.classList.add("selected");const d=document.createElement("span");d.className="map-node-level",d.textContent=n.id.toString();const p=(a==null?void 0:a.bestStars)??0,g=document.createElement("span");g.className="map-node-stars",g.textContent=s?et(p):"🔒",c.append(d,g),s?(c.title=`Klik untuk melihat detail Level ${n.id}`,c.addEventListener("click",()=>{kn(t)}),c.addEventListener("dblclick",()=>{O=t,Dn()}),c.addEventListener("keydown",y=>{(y.key==="Enter"||y.key===" ")&&(y.preventDefault(),kn(t))})):c.title="Terkunci. Selesaikan level sebelumnya.";const S=document.createElement("span");S.className="map-node-label",S.textContent=n.name,r&&S.classList.add("selected"),l.append(c,S),he.append(l)}Se==="menu"&&window.requestAnimationFrame(()=>{const t=he.querySelector(".map-node.selected")??he.querySelector(".map-node.current");if(!t)return;const n=dt,a=t.offsetTop-n.clientHeight/2+t.offsetHeight/2;n.scrollTo({top:Math.max(a,0),behavior:"smooth"})})}function Ka(e){e!==Tt&&(e==="won"&&_a(),Tt=e)}function _a(){const e=v[R],t=h.getStarCount(),n=h.getScore(),a=h.getHighestCombo(),s=Number(h.getScorePerMove().toFixed(2)),o=H,i=A,{profile:r,unlockedLevels:l}=Na(H,e.id,t,n,v.length,a,s);r!==o&&(H=nt(r,v.length),rn());const u=o.levelProgress[e.id],c=u?{stars:u.bestStars,combo:u.bestCombo,efficiency:u.bestEfficiency}:{stars:0,combo:0,efficiency:0};if(l.length>0){const p=l.map(g=>{const S=v.find(y=>y.id===g);return S?`Level ${S.id} – ${S.name}`:`Level ${g}`}).join(", ");b.includes(p)||(b=`${b?`${b} | `:""}${p} terbuka!`)}const d=Wa(i,A);Le(),qa({stars:t,score:n,combo:a,efficiency:s,previousBest:c,level:e,unlockedLevels:l}),d.length>0?Xa(d):Gn()}function qa({stars:e,score:t,combo:n,efficiency:a,previousBest:s,level:o,unlockedLevels:i}){const r=Math.max(e,s.stars),l=Math.max(n,s.combo),u=Math.max(a,s.efficiency),c=[];if(e>s.stars&&c.push("bintang"),n>s.combo&&c.push("combo"),a>s.efficiency&&c.push("skor/langkah"),c.length>0){const S=c.length===1?c[0]:`${c.slice(0,-1).join(", ")} & ${c[c.length-1]}`;qe.textContent=`Rekor Baru! (${S})`}else qe.textContent=`Level ${o.id} selesai!`;Dt.textContent=`Skor ${t.toLocaleString("id-ID")}.`,ce.innerHTML="";const d=document.createElement("li");d.textContent=`⭐ Bintang: ${e} (rekor: ${r})`,ce.append(d);const p=document.createElement("li");p.textContent=`⚡ Combo terbaik: ${n} (rekor: ${l})`,ce.append(p);const g=document.createElement("li");if(g.textContent=`🎯 Skor per langkah: ${a.toFixed(2)} (rekor: ${u.toFixed(2)})`,ce.append(g),i.length>0){const S=document.createElement("li");S.textContent=`🔓 Level baru: ${i.join(", ")}`,ce.append(S)}oe!==null&&(window.clearTimeout(oe),oe=null),X.classList.remove("hidden"),X.classList.remove("show"),X.offsetWidth,X.classList.add("show"),Fe=!0,za()}function Fn(){oe!==null&&(window.clearTimeout(oe),oe=null),!(!Fe&&X.classList.contains("hidden"))&&(X.classList.remove("show"),Fe=!1,oe=window.setTimeout(()=>{Fe||X.classList.add("hidden"),oe=null},Nn),Va())}function za(){ie!==null&&(window.clearTimeout(ie),ie=null),V.innerHTML="";const e=14;for(let t=0;t<e;t++){const n=document.createElement("span");n.className="confetti-piece";const a=(Math.random()-.5)*140,s=Math.random()*.2,o=(Math.random()-.5)*120,i=Math.floor(Math.random()*30)+340,r=Ya();n.style.setProperty("--confetti-offset-x",`${a}px`),n.style.setProperty("--confetti-delay",`${s}s`),n.style.setProperty("--confetti-rotation",`${o}deg`),n.style.setProperty("--confetti-color",r[t%r.length]),n.style.setProperty("--confetti-hue",`${i}`),V.append(n)}V.classList.remove("active"),V.offsetWidth,V.classList.add("active"),ie=window.setTimeout(()=>{V.classList.remove("active"),V.innerHTML="",ie=null},900)}function Va(){V.classList.remove("active"),V.innerHTML="",ie!==null&&(window.clearTimeout(ie),ie=null)}function Ya(){const e=v[R],t=H.levelProgress[e.id],n=(t==null?void 0:t.bestStars)??0;return n>=3?["#facc15","#fde047","#f97316","#fb7185"]:n===2?["#38bdf8","#fb923c","#a855f7","#facc15"]:n===1?["#60a5fa","#34d399","#fbbf24"]:["#64748b","#38bdf8","#f97316"]}function Wa(e,t){const n=[];for(const a of t.missions){const s=e.progress[a.id],o=t.progress[a.id];o!=null&&o.completed&&(s!=null&&s.completed||n.push(a))}return n}function Xa(e){Q!==null&&(window.clearTimeout(Q),Q=null),ze.innerHTML="",e.forEach(t=>{const n=document.createElement("li");n.textContent=`🎯 ${t.title} selesai! Klaim +${t.reward}.`,ze.append(n)}),Y.classList.remove("hidden"),Y.classList.remove("show"),Y.offsetWidth,Y.classList.add("show"),Q=window.setTimeout(()=>{Gn()},4e3)}function Gn(){if(Q!==null&&(window.clearTimeout(Q),Q=null),!Y.classList.contains("show")){Y.classList.add("hidden");return}Y.classList.remove("show"),Q=window.setTimeout(()=>{Y.classList.add("hidden"),Q=null},Nn)}function tn(){return!(Se!=="game"||q||h.getStatus()!=="playing"||de||te||I||J)}function nn(){be!==null&&(window.clearTimeout(be),be=null)}function an(){if(!W)return;W=null,_.querySelectorAll(".tile.hint-swap, .tile.hint-match").forEach(t=>{t.classList.remove("hint-swap","hint-match")})}function Ce(){nn(),an()}function Ze(){W||be!==null||tn()&&(be=window.setTimeout(()=>{be=null,Za()},Ia))}function Za(){if(!tn()||W){Ze();return}const e=h.getBoard(),t=ca(e);if(!t){Ze();return}W=t,L()}function F(){nn(),an(),Ze()}function Qa(e){const t=Ae();if(t){b=t,L();return}if($===e){$=null,P=null,b="Booster dinonaktifkan.",L();return}if(!h.canUseBooster(e)){$=null,P=null;const n=h.getBoosters();h.getStatus()!=="playing"?b="Booster hanya dapat digunakan ketika level berlangsung.":n[e]<=0?b=`${$e[e].label} habis.`:b=`${$e[e].label} belum tersedia.`,L();return}$=e,P=null,G=null,b=e==="hammer"?"Hammer aktif. Klik tile mana pun untuk menghancurkannya.":"Free Switch aktif. Pilih dua tile bertetangga untuk ditukar gratis.",L()}function L(){const e=h.getStatus();Ka(e),e!=="playing"&&($||P)&&($=null,P=null);const t=I?I.frames[I.index]:null,n=t?t.board:h.getBoard(),a=(t==null?void 0:t.removed)??[];let s;(t==null?void 0:t.type)==="match"?s="match":(t==null?void 0:t.type)==="cascade"?s="cascade":(t==null?void 0:t.type)==="special"&&(s="special");const o=te||q,i=h.getJellyGrid(),r=h.getCrateGrid(),l=$==="free-switch"&&P?us(P).filter(u=>sn(u)):[];Jn(),es(e),ts(n,e,i,r,{highlight:a,highlightType:s,disableInput:o,selected:G,boosterMode:$,boosterSelection:P,boosterTargets:l.length>0?l:void 0,hintSwap:W&&e==="playing"?[W.primary,W.secondary]:void 0,hintMatch:W?W.matches:void 0}),at.textContent=b,hs(e),q?ke.classList.remove("hidden"):ke.classList.add("hidden"),tn()?Ze():(nn(),e!=="playing"&&an()),Le()}function Jn(){_e.innerHTML="";const e=v[R],t=[Z("Koin",H.softCurrency.toLocaleString("id-ID")),Z(`Level ${e.id}`,e.name),Z("Skor",h.getScore().toLocaleString("id-ID")),Z("Langkah",`${h.getMovesLeft()} / ${e.moves}`),Z("Target",h.getTargetScore().toLocaleString("id-ID"))],n=h.getHighestCombo();n>0&&t.push(Z("Combo Terbaik",n.toString()));const a=h.getScorePerMove();a>0&&t.push(Z("Skor/Langkah",a.toLocaleString("id-ID",{maximumFractionDigits:1,minimumFractionDigits:1}))),h.hasJellyTarget()&&t.push(Z("Jelly",h.getJellyRemaining().toLocaleString("id-ID"))),h.hasCrateTarget()&&t.push(Z("Crate",h.getCrateRemaining().toLocaleString("id-ID"))),_e.append(...t)}function es(e){const t=h.getBoosters();Object.keys(Ve).forEach(n=>{const a=Ve[n],s=Et[n],o=t[n];s.textContent=`x${o}`;const i=e!=="playing"||q||te||o<=0;a.disabled=i,a.classList.toggle("active",!i&&$===n),a.classList.toggle("empty",o<=0),a.setAttribute("aria-pressed",(!i&&$===n).toString())})}function wn(e,t){const n=$e[e],a=document.createElement("button");a.type="button",a.className="booster-button",a.dataset.booster=e;const s=document.createElement("span");s.className="booster-icon",s.textContent=n.icon;const o=document.createElement("span");o.className="booster-label",o.textContent=n.label,t.className="booster-count",t.textContent="x0";const i=document.createElement("span");return i.className="booster-text",i.append(o,t),a.append(s,i),a.title=n.description,a.addEventListener("click",()=>{F(),Qa(e)}),a}function Z(e,t){const n=document.createElement("div");n.className="hud-item";const a=document.createElement("span");a.textContent=e;const s=document.createElement("strong");return s.textContent=t,n.append(a,s),n}function mt(e,t){const n=document.createElement("div");n.className="menu-stat";const a=document.createElement("span");return a.className="menu-stat-label",a.textContent=e,t.className="menu-stat-value",n.append(a,t),n}function ts(e,t,n,a,s={}){var d,p,g,S,y;_.innerHTML="",_.style.gridTemplateColumns=`repeat(${e.length}, 1fr)`,_.style.gridTemplateRows=`repeat(${e.length}, 1fr)`;const o=new Set((d=s.highlight)==null?void 0:d.map(le)),i=s.disableInput||t!=="playing",r=new Set((p=s.hintSwap)==null?void 0:p.map(le)),l=new Set((g=s.hintMatch)==null?void 0:g.map(le));(S=s.hintSwap)==null||S.forEach(k=>{l.delete(le(k))});const u=s.boosterSelection?le(s.boosterSelection):null,c=new Set(((y=s.boosterTargets)==null?void 0:y.map(k=>le(k)))??[]);e.forEach((k,C)=>{k.forEach((M,m)=>{var U,x;const f=document.createElement("div");f.className="tile",f.dataset.row=C.toString(),f.dataset.col=m.toString();const E=((U=n[C])==null?void 0:U[m])??0,T=((x=a[C])==null?void 0:x[m])??0;M?(ns(f,M),s.highlightType==="cascade"&&f.classList.add("cascade")):f.classList.add("hidden"),E>0&&(f.classList.add("jelly"),f.dataset.jelly=E.toString(),f.title?f.title=`${f.title} • Jelly ${E} lapis`:f.title=`Jelly ${E} lapis`),T>0&&(f.classList.add("crate"),f.dataset.crate=T.toString(),f.title?f.title=`${f.title} • Crate ${T} lapis`:f.title=`Crate ${T} lapis`);const z=le({row:C,col:m});o.has(z)&&(f.classList.add("matched"),s.highlightType==="special"&&f.classList.add("combo")),r.has(z)?f.classList.add("hint-swap"):l.has(z)&&f.classList.add("hint-match"),u&&z===u?(f.classList.add("booster-selected"),s.boosterMode&&(f.dataset.boosterMode=s.boosterMode)):f.dataset.boosterMode&&f.removeAttribute("data-booster-mode"),c.has(z)&&f.classList.add("booster-target"),s.selected&&s.selected.row===C&&s.selected.col===m&&f.classList.add("selected"),i&&f.classList.add("disabled"),f.addEventListener("pointerdown",N=>{rs({row:C,col:m},N)}),f.addEventListener("click",N=>{ds({row:C,col:m},N)}),_.append(f)})})}function ns(e,t){const n=Aa[t.kind];e.innerHTML="";const a=document.createElement("span");if(a.className="tile-icon",a.textContent=n.emoji,e.append(a),e.style.background=n.background,e.style.color=n.text,e.dataset.kind=t.kind,t.special){e.classList.add("special"),e.dataset.special=t.special;const s=document.createElement("span");s.className=`tile-special-badge special-${t.special}`,s.textContent=Ra[t.special],e.append(s),e.title=`${on(t.special)} (${n.name})`}else e.classList.remove("special"),e.removeAttribute("data-special"),e.title=n.name}function Ae(){return q?"Tutup layar tutorial untuk mulai bermain.":te?"Tunggu animasi selesai.":h.getStatus()!=="playing"?"Level sudah selesai. Gunakan tombol tindakan.":null}function as(){Xe||(window.addEventListener("pointermove",Hn,{passive:!1}),window.addEventListener("pointerup",On),window.addEventListener("pointercancel",Un),Xe=!0)}function ss(){Xe&&(window.removeEventListener("pointermove",Hn),window.removeEventListener("pointerup",On),window.removeEventListener("pointercancel",Un),Xe=!1)}function ft(e=!0){const t=J;if(t&&e)try{t.element.releasePointerCapture(t.pointerId)}catch{}return t&&Qe(t.element),J=null,ss(),t??null}function Qe(e){e.classList.remove("dragging","swap-preview","swap-revert"),e.style.removeProperty("--tile-translate-x"),e.style.removeProperty("--tile-translate-y"),e.style.removeProperty("--tile-scale")}function os(){_.classList.remove("swap-animating"),_.querySelectorAll(".tile").forEach(t=>{Qe(t)})}function is(e){if(!$)return;const t=Ae();if(t){b=t,L();return}if(F(),G=null,$==="hammer"){P=null;const n=h.useHammer(e);n.success?vn("hammer",n):Ln("hammer",n.reason),h.canUseBooster("hammer")||($=null);return}if($==="free-switch"){if(!P){P=e,b="Pilih tile tetangga untuk Free Switch.",L();return}if(P.row===e.row&&P.col===e.col){P=null,b="Seleksi Free Switch dibatalkan.",L();return}if(!Kn(P,e)){P=e,b="Pilih dua tile bertetangga untuk Free Switch.",L();return}const n=P;P=null;const a=h.useFreeSwitch(n,e);a.success?vn("free-switch",a):Ln("free-switch",a.reason),h.canUseBooster("free-switch")||($=null);return}}function vn(e,t){const n=$e[e].label,a=t.cascades,s=a.flatMap(l=>l.createdSpecials);let o;if(a.length===0)e==="free-switch"&&t.reason==="no-match"?o=`${n}: Pertukaran gratis tidak menghasilkan match.`:o=`${n}: Papan diperbarui.`;else{const l=a[0],u=l?l.removed.length+l.createdSpecials.length:0;o=a.length>1?`${n}: Kombo ${a.length} cascade! +${t.scoreGain} skor.`:`${n}: ${u} tile terhapus. +${t.scoreGain} skor.`}if(s.length>0){const l=Array.from(new Set(s.map(u=>on(u.special))));o+=` | Special baru: ${Wn(l)}`}h.hasJellyTarget()&&(t.clearedJelly>0&&(o+=` | Jelly bersih: ${t.clearedJelly}`),o+=` | Jelly tersisa: ${t.jellyRemaining}`),h.hasCrateTarget()&&(t.clearedCrate>0&&(o+=` | Crate pecah: ${t.clearedCrate}`),o+=` | Crate tersisa: ${t.crateRemaining}`);const i=a.reduce((l,u)=>l+u.removed.length,0),r=s.length;if(Yn({score:t.scoreGain,match:i,special:r,jelly:t.clearedJelly,crate:t.clearedCrate}),G=null,t.frames.length<=1){b=o,L();return}qn(t.frames,o)}function Ln(e,t){const n=$e[e].label;let a;switch(t){case"no-charge":a=`${n} habis. Kumpulkan lagi untuk memakainya.`,$=null,P=null;break;case"not-playing":a="Booster hanya dapat digunakan ketika level sedang berlangsung.",$=null,P=null;break;case"invalid-target":a=`${n}: Target tidak bisa digunakan.`;break;case"not-adjacent":a=`${n}: Pilih dua tile yang saling bertetangga.`;break;case"out-of-bounds":a="Target berada di luar papan.";break;default:a=`${n} tidak dapat digunakan sekarang.`;break}b=a,L()}function rs(e,t){if(!t.isPrimary||t.pointerType==="mouse"&&t.button!==0)return;if($){t.preventDefault();return}if(de||J)return;const n=Ae();if(n){b=n,L();return}F(),J={start:e,pointerId:t.pointerId,originX:t.clientX,originY:t.clientY,element:t.currentTarget};const a=J.element;a.classList.add("dragging"),a.style.setProperty("--tile-translate-x","0px"),a.style.setProperty("--tile-translate-y","0px"),a.style.setProperty("--tile-scale","1.1");try{t.currentTarget.setPointerCapture(t.pointerId)}catch{}t.pointerType==="touch"&&t.preventDefault(),as()}function Hn(e){if(!J||e.pointerId!==J.pointerId)return;const t=e.clientX-J.originX,n=e.clientY-J.originY;if(Math.max(Math.abs(t),Math.abs(n))<ja){ls(t,n),e.pointerType!=="mouse"&&e.preventDefault();return}const o=Math.abs(t)>Math.abs(n)?{row:0,col:t>0?1:-1}:{row:n>0?1:-1,col:0},i=ft();if(!i)return;const r={row:i.start.row+o.row,col:i.start.col+o.col};if(ye=!0,!sn(r)){ye=!1;return}e.preventDefault(),cs(i.start,r)}function On(e){!J||e.pointerId!==J.pointerId||ft()}function Un(e){!J||e.pointerId!==J.pointerId||ft()}function ls(e,t){if(!J)return;const n=J.element,a=Math.abs(e)>=Math.abs(t),s=a?Cn(e,-De,De):0,o=a?0:Cn(t,-De,De);n.style.setProperty("--tile-translate-x",`${s}px`),n.style.setProperty("--tile-translate-y",`${o}px`)}function Cn(e,t,n){return Math.max(t,Math.min(n,e))}function cs(e,t){F(),_n(e,t)}function sn(e){const t=h.getBoard().length;return e.row>=0&&e.col>=0&&e.row<t&&e.col<t}function Kn(e,t){const n=Math.abs(e.row-t.row),a=Math.abs(e.col-t.col);return n===1&&a===0||n===0&&a===1}function us(e){return[{row:e.row-1,col:e.col},{row:e.row+1,col:e.col},{row:e.row,col:e.col-1},{row:e.row,col:e.col+1}].filter(n=>sn(n))}function ds(e,t){if($){t==null||t.preventDefault(),ye=!1,is(e);return}if(ye){ye=!1,t==null||t.preventDefault();return}if(de){t==null||t.preventDefault();return}const n=Ae();if(n){b=n,L();return}if(F(),!G){G=e,b="Pilih permen tetangga untuk ditukar.",L();return}if(G.row===e.row&&G.col===e.col){G=null,b="Seleksi dibatalkan.",L();return}if(!Kn(G,e)){G=e,b="Permen tidak bertetangga. Seleksi digeser.",L();return}_n(G,e)}async function _n(e,t){if(de)return;const n=Ae();if(n){b=n,L();return}Ce(),de=!0,G=null;try{const a=h.trySwap(e,t);let s=null;if((a.success||a.reason==="no-match")&&(s=ms(e,t,{revert:!a.success})),s&&await s,!a.success){let o;a.reason==="no-match"?o="Swap tidak menghasilkan match.":a.reason==="not-adjacent"?o="Permen tidak bertetangga.":a.reason==="out-of-bounds"?o="Langkah di luar papan.":o="Langkah tidak valid.",h.hasJellyTarget()&&(o+=` | Jelly tersisa: ${h.getJellyRemaining()}`),h.hasCrateTarget()&&(o+=` | Crate tersisa: ${h.getCrateRemaining()}`),b=o,L();return}fs(a)}finally{de=!1}}function Mn(e){return _.querySelector(`.tile[data-row="${e.row}"][data-col="${e.col}"]`)}function ms(e,t,n){const a=Mn(e),s=Mn(t);if(!a||!s)return Promise.resolve();const o=a.getBoundingClientRect(),i=s.getBoundingClientRect(),r=i.left-o.left,l=i.top-o.top;return a.classList.add("swap-preview"),s.classList.add("swap-preview"),a.style.setProperty("--tile-translate-x",`${r}px`),a.style.setProperty("--tile-translate-y",`${l}px`),s.style.setProperty("--tile-translate-x",`${-r}px`),s.style.setProperty("--tile-translate-y",`${-l}px`),_.classList.add("swap-animating"),new Promise(u=>{window.setTimeout(()=>{n.revert?(a.classList.add("swap-revert"),s.classList.add("swap-revert"),a.style.setProperty("--tile-translate-x","0px"),a.style.setProperty("--tile-translate-y","0px"),s.style.setProperty("--tile-translate-x","0px"),s.style.setProperty("--tile-translate-y","0px"),window.setTimeout(()=>{Qe(a),Qe(s),_.classList.remove("swap-animating"),u()},bn)):(_.classList.remove("swap-animating"),u())},bn)})}function fs(e){const t=e.cascades[0],n=t?t.removed.length+t.createdSpecials.length:0;let a=e.cascades.length>1?`Kombo ${e.cascades.length} cascade! +${e.scoreGain} skor.`:`Match ${n} permen. +${e.scoreGain} skor.`;const s=e.cascades.flatMap(r=>r.createdSpecials);if(s.length>0){const r=Array.from(new Set(s.map(l=>on(l.special))));a+=` | Special baru: ${Wn(r)}`}h.hasJellyTarget()&&(e.clearedJelly>0&&(a+=` | Jelly bersih: ${e.clearedJelly}`),a+=` | Jelly tersisa: ${e.jellyRemaining}`),h.hasCrateTarget()&&(e.clearedCrate>0&&(a+=` | Crate pecah: ${e.clearedCrate}`),a+=` | Crate tersisa: ${e.crateRemaining}`);const o=e.cascades.reduce((r,l)=>r+l.removed.length,0),i=s.length;Yn({score:e.scoreGain,match:o,special:i,jelly:e.clearedJelly,crate:e.clearedCrate}),G=null,qn(e.frames,a)}function qn(e,t){var n;if(e.length===0){b=t,L();return}ht(),Ce(),I={frames:e,index:0,timer:null,finalMessage:t},te=!0,b=((n=e[0])==null?void 0:n.type)==="special"?"Special combo aktif!":"Permen meledak...",zn()}function zn(){if(!I)return;L();const e=I.frames[I.index],t=Ba[e.type]??240;if(I.index>=I.frames.length-1){const n=I.finalMessage;te=!1,I=null,b=n,L();return}I.timer=window.setTimeout(()=>{I&&(I.index+=1,zn())},t)}function ht(){(I==null?void 0:I.timer)!=null&&window.clearTimeout(I.timer),I=null,te=!1}function hs(e){if(e==="won"){const t=v[R],n=h.getStarCount();Te.textContent=`Level ${t.id} selesai! Target tercapai.`,Pe.textContent=et(n);const a=[];h.hasJellyTarget()&&a.push("Semua jelly bersih!"),h.hasCrateTarget()&&a.push("Semua crate pecah!"),t.description&&a.push(t.description),a.length===0&&a.push("Hebat! Lanjutkan progresmu.");const s=a.join(" ");xe.textContent=s,fe.replaceChildren(),Vn()&&fe.append(ot),pe.classList.remove("hidden");return}if(e==="lost"){Te.textContent="Kesempatan habis. Coba lagi!",Pe.textContent=et(h.getStarCount());const t=["Gunakan langkah secara efisien untuk mencapai target."];h.hasJellyTarget()&&t.push(`Jelly tersisa: ${h.getJellyRemaining().toLocaleString("id-ID")}.`),h.hasCrateTarget()&&t.push(`Crate tersisa: ${h.getCrateRemaining().toLocaleString("id-ID")}.`);const n=t.join(" ");xe.textContent=n,fe.replaceChildren(it),pe.classList.remove("hidden");return}pe.classList.add("hidden"),Te.textContent="",Pe.textContent="",xe.textContent="",fe.replaceChildren()}function et(e,t=3){let n="";for(let a=0;a<t;a++)n+=a<e?"★":"☆",a<t-1&&(n+=" ");return n}function Vn(){return R<v.length-1}function ps(e){const t=v[e];if(!t)return!1;const n=H.levelProgress[t.id];return(n==null?void 0:n.unlocked)??!1}function le(e){return`${e.row},${e.col}`}function on(e){switch(e){case"line-row":return"Garis Horizontal";case"line-col":return"Garis Vertikal";case"bomb":return"Bom 3x3";case"block":return"Ledakan 5x5";case"color":return"Color Bomb";default:return"Special"}}function gs(){const e=ys(),t=new Date;let n=e??va();n={missions:Ke,progress:{...n.progress},generatedAt:n.generatedAt};for(const a of Ke)n.progress[a.id]||(n.progress[a.id]={id:a.id,progress:0,completed:!1,claimed:!1});return n=$n(n,t),pt(n),n}function ys(){try{const e=window.localStorage.getItem(Bn);if(!e)return null;const t=JSON.parse(e);return!(t!=null&&t.missions)||!(t!=null&&t.progress)?null:t}catch(e){return console.warn("Gagal memuat mission state",e),null}}function pt(e){try{window.localStorage.setItem(Bn,JSON.stringify(e))}catch(t){console.warn("Gagal menyimpan mission state",t)}}function rn(){H=nt(H,v.length),xa(jn,H)}function we(){Ye.innerHTML="",A=$n(A,new Date),pt(A);for(const t of A.missions){const n=A.progress[t.id];n&&Ye.append(bs(t,n))}Le()}function bs(e,t){const n=document.createElement("div");n.className=`mission mission-${e.timeframe}`;const a=document.createElement("div");a.className="mission-title",a.textContent=e.title;const s=document.createElement("div");s.className="mission-desc",s.textContent=e.description;const o=document.createElement("div");o.className="mission-progress";const i=document.createElement("div");i.className="mission-progress-fill";const r=e.target===0?1:Math.min(1,t.progress/e.target);i.style.width=`${r*100}%`,o.append(i);const l=document.createElement("div");l.className="mission-footer";const u=document.createElement("span");u.textContent=Ma(t,e);const c=document.createElement("span");if(c.textContent=`Hadiah: ${e.reward}`,l.append(u,c),t.completed&&n.classList.add("completed"),t.claimed&&(n.classList.add("claimed"),c.textContent=`Hadiah: ${e.reward} ✅`),n.append(a,s,o,l),t.completed&&!t.claimed){const d=document.createElement("button");d.className="mission-claim",d.textContent=`Klaim +${e.reward}`,d.addEventListener("click",()=>{F(),ks(e)}),n.append(d)}return n}function Yn(e){if(!Object.values(e).some(a=>a!==void 0&&a>0))return;A=La(A,e),pt(A),we()}function ks(e){const t=A.progress[e.id];if(!(t!=null&&t.completed)||t.claimed)return;const n=Ca(A,e.id);n!==A&&(A=n,pt(A),H=$a(H,e.reward),rn(),Jn(),we(),b=`Hadiah misi "${e.title}" diterima!`,at.textContent=b)}function Wn(e){if(e.length===0)return"";if(e.length===1)return e[0];const t=e.pop();return`${e.join(", ")} dan ${t}`}L();we();Rn();
